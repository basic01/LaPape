<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="css/productos.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700,900&display=swap" rel="stylesheet"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <title>Document</title>
</head>
<body>
    <div class="top">
        <a href="productos.html"><h1>La Pape</h1></a>
        <div class="opciones">
            <i class="fas fa-user"></i>
            <i class="fas fa-shopping-cart"></i>
        </div>  
    </div>

    <div class="shopping-cart">
        <div id="shopping-cart-items">
            
        </div>

        <div class="shopping-cart-total">
            <div class="shopping-cart-total-subtotal total-data">
                <h4>Subtotal:</h4>
                <p>$<span id="subtotal">0.00</span></p>
            </div>
            <div class="shopping-cart-total-envio total-data">
                <h4>Envío:</h4>
                <p>$<span id="envio">0.00</span></p>
            </div>
            <div class="shopping-cart-total-total total-data">
                <h3>Total:</h3>
                <p>$<span id="total">0.00</span></p>
            </div>
        </div>
        <div class="shopping-cart-options">
            <button id="clear" class="boton">Vaciar</button>
            <button id="shop" class="boton">Comprar</button>
        </div>

    </div>

    <div class="container-fluid contenedor">
        <div class="row">
            <div class="col-lg-12">
                <div class="row tarjetas" id="tarjetas">
                    <h1>Productos disponibles</h1>


                    <!-- <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
                        <div class="tarjeta" id="tarjeta1">
                            <a href="producto.html" class="enlaceProducto">
                                <input type="hidden" name="" value=1>
                                <h3 class="nombre">Lápiz no.2</h3>
                                <img src="img/lapiz.png" alt="" class="imagen">
                                <label class="costo">$4.00</label>
                            </a>
                            <div class="cantidad">
                                <h4>Cantidad:</h4>
                                <input type="number" name="" id="" class="cant">
                            </div>
                            <button class="boton btnTarjeta">Agregar a carrito</button>
                        </div>
                    </div>

                    


                    <script>
                        localStorage.clear();

                        //Agregar funcionalidad a botones de cada tarjeta
                        let btns = document.getElementsByClassName('btnTarjeta');
                        for (let index = 0; index < btns.length; index++) {
                            btns[index].addEventListener('click', agregarCarrito);;
                        }
                        
                        cont = 0;
                        function agregarCarrito (){
                            //Obtener div padre (div.tarjeta)
                            const div = event.target.parentElement;
                            //Obtener valores de la tarjeta seleccionada
                            const cantidad = div.getElementsByClassName('cant')[0].value;
                            if(cantidad>0){
                                const nombre = div.getElementsByClassName('nombre')[0].innerText;
                                const imagen = div.getElementsByClassName('imagen')[0].src;
                                const precio = div.getElementsByClassName('costo')[0].innerText;
                                cont++;
                                const id = cont;
                                let cartItem = {
                                    id: id,
                                    nombre: nombre,
                                    imagen: imagen,
                                    precio: precio,
                                    cantidad: cantidad
                                };
                            
                            document.getElementById('shopping-cart-items').innerHTML += 
                                `
                                <div class="shopping-cart-item">
                                    <img src=${imagen} alt="" class="shopping-cart-item-img">
                                    <div class="shopping-cart-item-data">
                                        <p class="shopping-cart-item-nombre">${nombre}</p>
                                        <p class="shopping-cart-item-precio">Precio: $${precio}</p>
                                        <p class="shopping-cart-item-cantidad">Cantidad: ${cantidad}</p>
                                    </div>
                                    <i class="fas fa-trash"></i>
                                </div>
                                `;
                                
                            }
                            else{
                                alert('no hay cantidad');
                            }
                        }

                    </script> -->
                
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>

    //Obtener datos de API y poner en tarjetas
    const url = 'http://127.0.0.1:8000/productos/';
    async function obtenerData (url, divId){
        const response = await fetch(url);
        const data = await response.json();
        const div = document.getElementById(divId);
        data.forEach(element => {
            div.innerHTML += `
                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
                    <div class="tarjeta" id="tarjeta1">
                        <a href="producto.html?e=${element.id}" class="enlaceProducto">
                            <input type="hidden" class="idProducto" name="" value=${element.id}>
                            <h3 class="nombre">${element.nombre}</h3>
                            <img src=${element.imagen} alt="" class="imagen">
                            <label>$<span class="costo">${element.precio}</span></label>
                        </a>
                        <div class="cantidad">
                            <h4>Cantidad:</h4>
                            <input type="number" name="" id="" class="cant">
                        </div>
                        <button class="boton btnTarjeta">Agregar a carrito</button>
                    </div>
                </div>
            `
        });
    }

    //Función para llamar funciones asíncronas
    async function work(){
        await obtenerData(url, 'tarjetas');
        await addBtnFunctionality();
    }
    
    work();

    //Agregar funcionalidad a botones de cada tarjeta
    function addBtnFunctionality(){
        let btns = document.getElementsByClassName('btnTarjeta');
        for (let index = 0; index < btns.length; index++) {
            btns[index].addEventListener('click', agregarCarrito);
        }
    }
    
    //Borrar item de carrito
    function deleteItem(){
        const div = event.target.parentElement;
        div.parentNode.removeChild(div);
        datosDineroCompra();
    }

    async function datosDineroCompra(){
        const subtotal = document.getElementById('subtotal');
        const envio = document.getElementById('envio');                
        const total = document.getElementById('total');
        const sub = await obtenerSubtotal();
        const tot = sub + 50;
        subtotal.innerText = sub;
        if(sub == 0){
            envio.innerText = 0.00;
            total.innerText = 0.00;
        }
        else{
            envio.innerText = 50.00;
            total.innerText = tot;
        }
        
    }

    //Agregar item a carrito
    async function agregarCarrito(){
        //Obtener div padre (div.tarjeta)
        const div = event.target.parentElement;
        //Obtener valores de la tarjeta seleccionada
        const cantidad = div.getElementsByClassName('cant')[0].value;
        const id = div.getElementsByClassName('idProducto')[0].value;
        if(cantidad>0){
            const banderaItemExiste = await validarItemCarrito(id);
            if(!banderaItemExiste){
                const nombre = div.getElementsByClassName('nombre')[0].innerText;
                const imagen = div.getElementsByClassName('imagen')[0].src;
                const precio = div.getElementsByClassName('costo')[0].innerText;
                
                // let cartItem = {
                //     id: id,
                //     nombre: nombre,
                //     imagen: imagen,
                //     precio: precio,
                //     cantidad: cantidad
                // };
            
                //Crear item y agrergarlo a carrito
                document.getElementById('shopping-cart-items').innerHTML += 
                    `
                    <div class="shopping-cart-item">
                        <img src=${imagen} alt="" class="shopping-cart-item-img">
                        <div class="shopping-cart-item-data">
                            <input type="hidden" class="idItem" name="" value=${id}>
                            <p class="shopping-cart-item-nombre">${nombre}</p>
                            <p class="shopping-cart-item-precio">Precio: $<span class="cart-item-precio">${precio}</span></p>
                            <p class="shopping-cart-item-cantidad">Cantidad: <span class="cart-item-cantidad">${cantidad}</span></p>
                        </div>
                        <i class="fas fa-trash eliminarItem" onclick="deleteItem()"></i>
                    </div>
                `;
                datosDineroCompra();
            }

            else{
                alert('Elemento ya está en el carrito');
            }   
        }
        else{
            alert('no hay cantidad');
        }
    }

    //Función para validar si ya está el item en el carrito
    async function validarItemCarrito(idItem){
        let bandera = false;
        const items = await document.querySelectorAll('.shopping-cart-item');
        items.forEach(element => {
            const id = element.getElementsByClassName('idItem')[0].value;
            if(idItem == id){
                bandera = true;
            }
        });
        
        return bandera;
    }

    async function obtenerSubtotal(){
        const items = await document.querySelectorAll('.shopping-cart-item');
        let subtotal = 0;
        items.forEach(element => {
            let precio = element.getElementsByClassName('cart-item-precio')[0].innerText;
            let cantidad = element.getElementsByClassName('cart-item-cantidad')[0].innerText;
            cantidad = parseInt(cantidad);
            precio = parseFloat(precio);
            subtotal += cantidad * precio;
        });
        
        return subtotal;
    }

</script>